CC = g++

#-----------------------------------------------
# Uncomment exactly one of the lines labelled (A), (B), and (C) below
# to switch between compilation modes.

OPT = -Wall -DLINUX=2 -D_REENTRANT -D_GNU_SOURCE -g -rdynamic
DEBUG ?= 1
ifeq "${DEBUG}" "1"
OPT += -DDEBUG_TIME
else
OPT += -O2 -DNDEBUG
endif

#OPT = -O2 -DNDEBUG       # (A) Production use (optimized mode)
# OPT = -g2              # (B) Debug mode, w/ full line-level debugging symbols
# OPT = -O2 -g2 -DNDEBUG # (C) Profiling mode: opt, but w/debugging symbols
#-----------------------------------------------

# detect what platform we're building on
$(shell sh ./build_detect_platform)
# this file is generated by build_detect_platform to set build flags
include build_config.mk

ULIB=$(HOME)/ulib
ULIB_INC =$(ULIB)/include
ULIB_PATH=$(ULIB)/lib

CFLAGS = -I. -I./include -I$(ULIB_INC) -D_FILE_OFFSET_BITS=64 $(PORT_CFLAGS) $(PLATFORM_CFLAGS) $(OPT)

LDFLAGS=$(PLATFORM_LDFLAGS)

CPPFLAGS = $(CFLAGS)
LDFLAGS += -L$(ULIB_PATH)
LIBS = -luv -lhiredis
LIBO = as_search

all	: $(LIBO)

as_search : main.o server.o core.o
	$(CC) -o $@ $^ $(CPPFLAGS) $(LDFLAGS) $(LIBS)

.PHONY : clean cleanall tags

tags:
	@ctags *.h *.c*

clean:
	@rm -f *.o *~ $(LIBO)
cleanall: clean
	@rm -f tags build_config.mk
